<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>System design: Plugin frame · Invest</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Although an Invest plugin can be a completely standalone web application, it is likely that most plugins will integrate some of the functionality on offer from the Invest Server or Outer Frame. In order to communicate with these the plugin uses the Invest connection layer."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="System design: Plugin frame · Invest"/><meta property="og:type" content="website"/><meta property="og:url" content="https://commitd.github.com/invest/invest/index.html"/><meta property="og:description" content="Although an Invest plugin can be a completely standalone web application, it is likely that most plugins will integrate some of the functionality on offer from the Invest Server or Outer Frame. In order to communicate with these the plugin uses the Invest connection layer."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/invest/undefined"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/invest/css/main.css"/></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/invest/"><h2 class="headerTitle">Invest</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/invest/docs/about.html" target="_self">About</a></li><li class=""><a href="/invest/docs/dev.reading-list.html" target="_self">Development</a></li><li class="siteNavGroupActive"><a href="/invest/docs/ui.index.html" target="_self">UI</a></li><li class=""><a href="/invest/docs/server.index.html" target="_self">Server</a></li><li class=""><a href="https://github.com/commitd/invest-server" target="_self">Server Source</a></li><li class=""><a href="https://github.com/commitd/invest-ui" target="_self">UI Source</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Design</span></h2></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul><li class="navListItem"><a class="navItem" href="/invest/docs/ui.index.html">Invest UI</a></li><li class="navListItem"><a class="navItem" href="/invest/docs/ui.faq.html">FAQ</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Concepts</h3><ul><li class="navListItem"><a class="navItem" href="/invest/docs/ui.ux.html">User interface and experience</a></li><li class="navListItem"><a class="navItem" href="/invest/docs/ui.technologies.html">Invest UI Technologies</a></li><li class="navListItem"><a class="navItem" href="/invest/docs/ui.modules.html">Invest UI Modules</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Design</h3><ul><li class="navListItem"><a class="navItem" href="/invest/docs/ui.system-comms.html">System design: Communications</a></li><li class="navListItem"><a class="navItem" href="/invest/docs/ui.system-outer.html">System design: Outer frame</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/invest/docs/ui.system-plugin.html">System design: Plugin frame</a></li><li class="navListItem"><a class="navItem" href="/invest/docs/ui.system-url.html">System design: URL</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Developing UIs</h3><ul><li class="navListItem"><a class="navItem" href="/invest/docs/ui.dev-ui-extension.html">Developing UI modules</a></li><li class="navListItem"><a class="navItem" href="/invest/docs/ui.dev-app-module.html">Advanced: Developing a new main application frontend</a></li><li class="navListItem"><a class="navItem" href="/invest/docs/ui.dev-core-module.html">Advanced: Developing a core module</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Support</h3><ul><li class="navListItem"><a class="navItem" href="/invest/docs/ui.live-development-plugin.html">Live development plugin</a></li><li class="navListItem"><a class="navItem" href="/invest/docs/ui.action-development-plugin.html">Action development plugin</a></li></ul></div></div></section></div><script>
            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">System design: Plugin frame</h1></header><article><div><span><p>Although an Invest plugin can be a completely standalone web application, it is likely that most plugins will integrate some of the functionality on offer from the Invest Server or Outer Frame. In order to communicate with these the plugin uses the Invest connection layer.</p>
<p>There are two ways in which a Plugin can interact with the Outer Frame and hence the Invest Server.</p>
<ul>
<li>Receive push notification of lifecycle elements which are send by the Outer Frame.</li>
<li>Use the Plugin API to make requests of the Outer Frame (and from there the Invest Server).</li>
</ul>
<p>In the latter case this breaks down into distinct types of requests:</p>
<ul>
<li>Request GraphQL query or mutations</li>
<li>Request the Outer Frame performs an operation</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="lifecycle-notifications"></a><a href="#lifecycle-notifications" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lifecycle notifications</h2>
<p>The lifecycle notifications are one-way messages sent from the Outer Frame to the Plugin Frame to inform the Plugin about its current state within the application or ask the Plugin to change its state.</p>
<p>The following notifications are sent (defined in the <code>Plugin Lifecycle</code> interface):</p>
<ul>
<li>onLoad: A view of this plugin has been created. It will not be visible yet. A plugin could use this to start requesting data from the server. Most basic plugins do this as soon as possible (not waiting for onLoad)</li>
<li>onShow: The view of the plugin is being displayed to the user. The plugin should consider itself active.</li>
<li>onHide: The view of the plugin has been hidden from the user (typically the user is just looking at another plugin). The plugin should stop any complex work that may not be needed - e.g. animations, calculations, etc. Use the onShow to resume these.</li>
<li>onUnload: the view of the plugin is about to be removed, typically its iframe will be discarded. All the data associated with this instance will be lost. There is nothing the plugin can do to stop this, but it could save the data.</li>
<li>onAction: The plugin is being called with an intent (action and payload). The plugin should review this and act appropriately. It's safe to assume you should respond immediately (e.g. the plugin is either shown or about to receive onShow).</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="api"></a><a href="#api" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>API</h2>
<p>The API is as follows (see <code>InvestPluginApi.ts</code>), each returns a promise:</p>
<ul>
<li><code>fetch</code>: A specialised <code>fetch</code> which replicates the global fetch function of browser but which deals with addition of authentication information and the sandbox-ing of iframes. Developers should use this instead of global fetch (when talking to the Invest Server).</li>
<li><code>query(options, variables)</code> and <code>mutate(options, variables)</code> replicate the Apollo query and mutate functions. This can be useful for ad hoc queries, if you aren't using the React Apollo <code>graphql</code> function.</li>
<li><code>navigate(pluginId, action, payload)</code> request the outer frame navigate to the supplied pluginId, and  provide it the action and payload (optional).</li>
<li><code>findPlugins(action)</code> return a list of Plugins which implement the required action. This is really a shortcut for a Graphql query.</li>
</ul>
<p>The underlining communication mechanism is discuss in <a href="ui.system-comms.html">later</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="using-invest-plugin-react-support"></a><a href="#using-invest-plugin-react-support" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using Invest plugin React support</h2>
<p>The core elements of Invest are written in React, and if you also want to use React in your plugins then the <code>InvestUiPlugin</code> component simplifies development.</p>
<p><code>InvestUiPlugin</code> provides four functions:</p>
<ul>
<li>It sets up the InvestPluginApi using the RPC connection and Apollo, placing the plugin API into the context (as <code>pluginApi</code>)</li>
<li>It sets up React Apollo, connecting it to the RPC connection.</li>
<li>It handles some minor CSS around full size (100% width and height) vs non-fullscreen (padded) plugins. Use the 'fullscreen' support for maps and use the non-fullscreen support for tables, documents, etc.</li>
<li>It routes actions from the handler to props on the child component.</li>
</ul>
<p><img src="/invest/docs/assets/images/ui-sysdesign-plugin-react.png" alt="Plugin Frame React"></p>
<p>Whilst the others 'just happen', the last one require some implementation from the developer. We envisage the InvestUiPlugin component to be used in the React render as follows:</p>
<pre><code class="hljs css languages- typescript">ReactDOM.render(
 &lt;InvestUiPlugin fullscreen={false}&gt;
   &lt;App /&gt;
 &lt;/InvestUiPlugin&gt;,
 document.getElementById('root') as HTMLElement
)
</code></pre>
<p><code>App</code> is the root of the plugin's custom components. Note there is only a single component supported as a child of <code>InvestUiPlugin</code>. When plugin receives an <code>onAction(action,payload)</code> lifecycle event this is passed directly as props (action and payload) to the <code>App</code>. Thus the <code>App</code> can respond to an action in the way it would any other prop:</p>
<pre><code class="hljs css languages- typescript"> componentWillReceiveProps(nextProps: Props) {
   <span class="hljs-comment">// Process action / payload if its changed</span>
   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.props.action !== nextProps.action || !isEqual(<span class="hljs-keyword">this</span>.props.payload, nextProps.payload)) {
  
     <span class="hljs-comment">// If we support the action deal with it</span>
     <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.props.action === <span class="hljs-string">'dataset.view'</span>) {
       <span class="hljs-comment">// Payload is any, but we know it must be a view payload now</span>
       <span class="hljs-comment">// (TODO you'd need to verify this more closely perhaps)</span>
       <span class="hljs-keyword">const</span> payload = nextProps.payload <span class="hljs-keyword">as</span> ViewPayload
       <span class="hljs-keyword">this</span>.setState({
           datasetId: payload ? payload.datasetId : <span class="hljs-literal">undefined</span>,
       })
     }
   }
 }
</code></pre>
<p>Note in the above we retain a value from the payload in state. We find this a typical pattern - the state can then be used to decide what should happen in the <code>render()</code> function.</p>
<h2><a class="anchor" aria-hidden="true" id="without-react-but-in-a-bundle-packaged-app"></a><a href="#without-react-but-in-a-bundle-packaged-app" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Without React, but in a bundle/packaged app</h2>
<p>If you are not using React in your plugin (or don't wish to use the InvestUiPlugin component), then the utility React components are not necessary. Instead you can use the various invest libraries as dependencies in your own project (as <code>invest-plugin</code>).</p>
<p>This advice is applicable for example for Angular or any other custom Web App, etc application.</p>
<p>The key class to use it is <code>InvestPluginApi</code> which can be instanced directly or via the helper function <code>createInvestPluginApi</code>. The <code>InvestPluginApi</code> wraps both the React Apollo client and the RPC connection, providing the simple API defined above.</p>
<p><img src="/invest/docs/assets/images/ui-sysdesign-plugin-js.png" alt="Plugin Frame Js"></p>
<p>In order to use notifications you supply it with a handler for the lifecycle events of interest. You will likely want to retrieve the client and connection from it.</p>
<h2><a class="anchor" aria-hidden="true" id="inside-a-simple-indexhtml-page"></a><a href="#inside-a-simple-indexhtml-page" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Inside a simple index.html page</h2>
<p>If you wish to use Invest without any bundler, using simply an <code>index.html</code> page which has script tags this is also possible.</p>
<p>Part of the Invest build process creates a <code>umd</code> javascript bundle which you can include in your applications with:</p>
<pre><code class="hljs css languages- html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/path/to/invest.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>In order to gain full functionality you should also include <code>react</code> and <code>react-dom</code> in the same way.</p>
<p>Having done this you will have a global Invest variable which has an API as follows:</p>
<ul>
<li><code>Invest.connect()</code> being the same as <code>createInvestPluginApi</code> above</li>
<li><code>Invest.plugin.Api</code> being the same as <code>InvestPluginApi</code> above</li>
<li><code>Invest.utils.loggerFactory</code> being the Invest logger</li>
</ul>
<p>Thus, typically an application will simply need to:</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-keyword">var</span> invest = Invest.connect()

<span class="hljs-comment">// then use invest as the API above...</span>

invest.fetch(...)
invest.query(...)
invest.mutate(...)
invest.navigate(...)
invest.findPlugins(...)

<span class="hljs-comment">// or access the lower level objects</span>
invest.client
invest.connection
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/invest/docs/ui.system-outer.html">← System design: Outer frame</a><a class="docs-next button" href="/invest/docs/ui.system-url.html">System design: URL →</a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><div><h5>Sitemap</h5><a href="/invest/docs/about.html">About</a><a href="/invest/docs/server.index.html">Server</a><a href="/invest/docs/ui.index.html">UI</a></div><div><h5>Resources</h5><a href="https://github.com/commitd/invest">Source</a></div></section><section class="copyright">Copyright © 2018 Committed</section></footer></div></body></html>